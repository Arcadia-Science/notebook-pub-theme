# Reusable workflow for checking theme updates in notebook pub repos.
#
# This workflow lives in the theme repo so that changes to the update logic
# (PR format, reviewer, etc.) propagate to all pubs automatically. Each pub
# repo has a thin wrapper that calls this workflow on a schedule.

name: Check Theme Updates

on:
  workflow_call:
    inputs:
      reviewer:
        description: 'GitHub username to request review from'
        required: false
        type: string
        default: 'Robert-Roth'

permissions:
  contents: write
  pull-requests: write

jobs:
  check-theme-updates:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get current theme version
        id: current
        run: |
          VERSION=$(grep '^version:' _extensions/Arcadia-Science/arcadia-pub-theme/_extension.yml | cut -d' ' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Get latest theme version
        id: latest
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION=$(gh api repos/Arcadia-Science/notebook-pub-theme/releases/latest --jq '.tag_name' | sed 's/^v//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Check if update needed
        id: check
        run: |
          if [ "${{ steps.current.outputs.version }}" = "${{ steps.latest.outputs.version }}" ]; then
            echo "Theme is already up to date (${{ steps.current.outputs.version }})"
            echo "needed=false" >> $GITHUB_OUTPUT
          else
            echo "Update available: ${{ steps.current.outputs.version }} → ${{ steps.latest.outputs.version }}"
            echo "needed=true" >> $GITHUB_OUTPUT
          fi

      - name: Set up Quarto
        if: steps.check.outputs.needed == 'true'
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Update theme
        if: steps.check.outputs.needed == 'true'
        run: make update-theme

      - name: Create PR
        if: steps.check.outputs.needed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          branch: auto/theme-update
          commit-message: "[Theme] Update arcadia-pub-theme ${{ steps.current.outputs.version }} → ${{ steps.latest.outputs.version }}"
          delete-branch: true
          title: "[Theme] Update arcadia-pub-theme ${{ steps.current.outputs.version }} → ${{ steps.latest.outputs.version }}"
          reviewers: ${{ inputs.reviewer }}
          body: |
            Updates `arcadia-pub-theme` from ${{ steps.current.outputs.version }} to ${{ steps.latest.outputs.version }}.

            When this PR is merged, the theme will be synced to the `publish` branch and the site will be automatically re-rendered and deployed with the new theme.

            **Release notes:** https://github.com/Arcadia-Science/notebook-pub-theme/releases/tag/v${{ steps.latest.outputs.version }}

            **Changelog:** https://github.com/Arcadia-Science/notebook-pub-theme/blob/main/CHANGELOG.md
